<!-- pages/checkout/checkout.wxml -->
<view class="page">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="header">
    <view class="back-icon" bindtap="goBack">ã€ˆ</view>
    <view class="page-title">è®¢å•ç¡®è®¤</view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{isLoading}}">
    <view class="loading"></view>
    <view class="loading-text">åŠ è½½ä¸­...</view>
  </view>

  <!-- é¡µé¢å†…å®¹ -->
  <block wx:else>
    <!-- é…é€åœ°å€ -->
    <view class="address-section" bindtap="showAddressPopup">
      <view class="location-icon">ğŸ“</view>
      <view class="section-content">
        <view class="section-label">é…é€åœ°å€</view>
        <view class="address-info">
          <view>
            <text class="user-name">{{address.name}}</text>
            <text class="user-phone" wx:if="{{address.phone}}">{{address.phone}}</text>
          </view>
          <view class="address-text">{{address.address}}</view>
        </view>
      </view>
      <view class="arrow-icon">â€º</view>
    </view>

    <!-- é…é€æ—¶é—´ -->
    <view class="delivery-section" bindtap="showDeliveryTimePopup">
      <view class="time-icon">ğŸ•’</view>
      <view class="section-content">
        <view class="section-label">é…é€æ—¶é—´</view>
        <view class="time-value">{{deliveryTime}}</view>
      </view>
      <view class="arrow-icon">â€º</view>
    </view>
    
    <!-- è®¢å•å¤‡æ³¨ -->
    <view class="delivery-section" bindtap="showRemarksPopup">
      <view class="remark-icon">ğŸ“</view>
      <view class="section-content">
        <view class="section-label">è®¢å•å¤‡æ³¨</view>
        <view class="remark-value">{{remarks || 'æ·»åŠ è®¢å•å¤‡æ³¨'}}</view>
      </view>
      <view class="arrow-icon">â€º</view>
    </view>

    <!-- é…é€æç¤º -->
    <view class="notice-section">
      <view class="notice-icon">â„¹ï¸</view>
      <view class="notice-text">{{notification}}</view>
    </view>

    <!-- è®¢å•å•†å“åˆ—è¡¨ -->
    <view class="order-items-section">
      <view class="section-title">è®¢å•å•†å“</view>
      
      <view class="order-items">
        <block wx:for="{{orderItems}}" wx:key="id">
          <view class="order-item">
            <image class="item-image" src="{{item.image}}" mode="aspectFill"></image>
            <view class="item-details">
              <view class="item-name">{{item.name}}</view>
              <view class="item-spec">{{item.specs}}</view>
              <view class="item-price-row">
                <text class="item-price">Â¥{{item.price}}</text>
                <text class="item-count">x{{item.count}}</text>
              </view>
            </view>
          </view>
        </block>
      </view>
    </view>

    <!-- æ”¯ä»˜æ–¹å¼ -->
    <view class="payment-section">
      <view class="section-title">æ”¯ä»˜æ–¹å¼</view>
      
      <view class="payment-options">
        <block wx:for="{{paymentMethods}}" wx:key="id">
          <view class="payment-option {{item.selected ? 'selected' : ''}}" bindtap="selectPayment" data-id="{{item.id}}">
            <image class="payment-icon" src="/assets/images/payment/{{item.id == 'wechat' ? 'wechat-pay' : (item.id == 'cod' ? 'cash' : item.id)}}.png"></image>
            <view class="payment-name">{{item.name}}</view>
            <view class="payment-radio">
              <view class="radio-inner {{item.selected ? 'checked' : ''}}"></view>
            </view>
          </view>
        </block>
      </view>
    </view>

    <!-- è®¢å•é‡‘é¢ -->
    <view class="amount-section">
      <view class="section-title">è®¢å•é‡‘é¢</view>
      
      <view class="amount-list">
        <view class="amount-item">
          <text class="amount-label">å•†å“é‡‘é¢</text>
          <text class="amount-value">Â¥{{orderAmount.goodsTotal}}</text>
        </view>
        <view class="amount-item">
          <text class="amount-label">é…é€è´¹</text>
          <text class="amount-value">Â¥{{orderAmount.delivery}}</text>
        </view>
        <view class="amount-item discount" wx:if="{{orderAmount.discount > 0}}">
          <text class="amount-label">ä¼˜æƒ </text>
          <text class="amount-value">-Â¥{{orderAmount.discount}}</text>
        </view>
      </view>
      
      <view class="total-amount">
        <text class="total-label">å®ä»˜é‡‘é¢</text>
        <text class="total-value">Â¥{{orderAmount.total}}</text>
      </view>
    </view>

    <!-- æ”¯ä»˜æŒ‰é’® -->
    <view class="pay-btn-container">
      <button class="pay-btn" bindtap="confirmPayment">ç¡®è®¤æ”¯ä»˜ Â¥{{orderAmount.total}}</button>
    </view>
  </block>
  
  <!-- é…é€æ—¶é—´é€‰æ‹©å¼¹å‡ºå±‚ -->
  <view class="delivery-time-popup {{showTimePopup ? 'show' : ''}}" catchtouchmove="preventTouchMove">
    <view class="popup-mask" bindtap="hideDeliveryTimePopup"></view>
    <view class="popup-content">
      <view class="popup-header">
        <view class="popup-title">é€‰æ‹©é…é€æ—¶é—´</view>
        <view class="popup-close" bindtap="hideDeliveryTimePopup">âœ•</view>
      </view>
      
      <!-- æ—¥æœŸé€‰æ‹© -->
      <view class="time-section">
        <view class="section-title">é…é€æ—¥æœŸ</view>
        <scroll-view scroll-x="true" class="date-scroll">
          <view class="date-list">
            <view class="date-item {{selectedDateIndex === index ? 'active' : ''}}" 
                  wx:for="{{dateOptions}}" 
                  wx:key="date"
                  bindtap="selectDate"
                  data-index="{{index}}">
              <view class="day">{{item.day}}</view>
              <view class="date">{{item.date}}</view>
            </view>
          </view>
        </scroll-view>
      </view>
      
      <!-- æ—¶é—´æ®µé€‰æ‹© -->
      <view class="time-section">
        <view class="section-title">é…é€æ—¶é—´æ®µ</view>
        <view class="time-list">
          <view class="time-item {{selectedTimeIndex === index ? 'active' : ''}} {{item.disabled ? 'disabled' : ''}}"
                wx:for="{{timeOptions}}" 
                wx:key="time" 
                bindtap="selectTime"
                data-index="{{index}}">
            <view class="time">{{item.time}}</view>
            <view class="status" wx:if="{{item.tag}}">{{item.tag}}</view>
          </view>
        </view>
      </view>
      
      <!-- ç¡®è®¤æŒ‰é’® -->
      <view class="popup-footer">
        <button class="confirm-btn {{!canConfirm ? 'disabled' : ''}}" bindtap="confirmDeliveryTime" disabled="{{!canConfirm}}">ç¡®è®¤</button>
      </view>
    </view>
  </view>

  <!-- åœ°å€é€‰æ‹©å¼¹å‡ºå±‚ -->
  <view class="address-popup {{showAddressPopup ? 'show' : ''}}" catchtouchmove="preventTouchMove">
    <view class="popup-mask" bindtap="hideAddressPopup"></view>
    <view class="popup-content">
      <view class="popup-header">
        <view class="popup-title">é€‰æ‹©æ”¶è´§åœ°å€</view>
        <view class="popup-close" bindtap="hideAddressPopup">âœ•</view>
      </view>
      
      <!-- å¾®ä¿¡æ”¶è´§åœ°å€æŒ‰é’® -->
      <view class="wechat-address-btn-wrap">
        <button class="wechat-address-btn" bindtap="getWechatAddress">
          <text class="wx-icon">+</text>
          <text>è·å–å¾®ä¿¡æ”¶è´§åœ°å€</text>
        </button>
      </view>

      <!-- åœ°å€åˆ†å‰²çº¿ -->
      <view class="address-divider">
        <view class="divider-line"></view>
        <text class="divider-text">å·²ä¿å­˜åœ°å€</text>
        <view class="divider-line"></view>
      </view>
      
      <!-- åŠ è½½çŠ¶æ€ -->
      <view class="popup-loading" wx:if="{{addressLoading}}">
        <view class="loading-spinner"></view>
        <text class="loading-text">åŠ è½½ä¸­...</text>
      </view>
      
      <!-- ç©ºåœ°å€åˆ—è¡¨æç¤º -->
      <view class="popup-empty" wx:elif="{{addressEmpty}}">
        <image class="empty-icon" src="/images/icons/empty-address.png" mode="aspectFit"></image>
        <text class="empty-text">æš‚æ— æ”¶è´§åœ°å€</text>
      </view>
      
      <!-- åœ°å€åˆ—è¡¨ -->
      <scroll-view scroll-y="true" class="address-scroll" wx:else>
        <view class="address-list">
          <view class="address-item {{item.isDefault ? 'default' : ''}} {{item._id === selectedAddressId ? 'selected' : ''}}" 
                wx:for="{{addressList}}" 
                wx:key="_id" 
                bindtap="selectAddress" 
                data-id="{{item._id}}">
            <!-- é»˜è®¤åœ°å€æ ‡è®° -->
            <view class="address-badge" wx:if="{{item.isDefault}}">é»˜è®¤</view>
            
            <!-- åœ°å€ä¿¡æ¯ -->
            <view class="popup-address-info">
              <view class="address-top">
                <text class="address-name">{{item.name}}</text>
                <text class="address-phone">{{item.phone}}</text>
              </view>
              <view class="address-bottom">
                {{item.region[0]}} {{item.region[1]}} {{item.region[2]}} {{item.detailAddress}}
              </view>
            </view>
            
            <!-- é€‰æ‹©å›¾æ ‡ -->
            <view class="address-select-icon {{item._id === selectedAddressId ? 'checked' : ''}}"></view>
          </view>
        </view>
      </scroll-view>
      
      <!-- åº•éƒ¨æŒ‰é’® -->
      <view class="popup-footer address-footer">
        <button class="add-address-btn" bindtap="navigateToAddAddress">æ·»åŠ æ–°åœ°å€</button>
      </view>
    </view>
  </view>

  <!-- å¤‡æ³¨å¼¹å‡ºå±‚ -->
  <view class="remarks-popup {{showRemarksPopup ? 'show' : ''}}" catchtouchmove="preventTouchMove">
    <view class="popup-mask" bindtap="hideRemarksPopup"></view>
    <view class="popup-content">
      <view class="popup-header">
        <view class="popup-title">è®¢å•å¤‡æ³¨</view>
        <view class="popup-close" bindtap="hideRemarksPopup">âœ•</view>
      </view>
      
      <view class="remarks-input-container">
        <textarea class="remarks-input" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯ï¼ˆé€‰å¡«ï¼‰" maxlength="100" bindinput="onRemarksInput" value="{{tempRemarks}}"></textarea>
        <view class="remarks-counter">{{remarksLength || 0}}/100</view>
      </view>
      
      <view class="remarks-tips">
        <text class="tips-title">å¸¸ç”¨å¤‡æ³¨ï¼š</text>
        <view class="quick-remarks">
          <button class="quick-remark" hover-class="quick-remark-hover" bindtap="selectQuickRemark" data-remark="å°‘ç³–">å°‘ç³–</button>
          <button class="quick-remark" hover-class="quick-remark-hover" bindtap="selectQuickRemark" data-remark="å¤šåŠ ç‚¹é…æ–™">å¤šåŠ ç‚¹é…æ–™</button>
          <button class="quick-remark" hover-class="quick-remark-hover" bindtap="selectQuickRemark" data-remark="è¯·æ”¾åœ¨é—¨å£">è¯·æ”¾åœ¨é—¨å£</button>
        </view>
      </view>
      
      <view class="popup-footer">
        <button class="confirm-btn" bindtap="confirmRemarks">ç¡®è®¤</button>
      </view>
    </view>
  </view>
</view> 