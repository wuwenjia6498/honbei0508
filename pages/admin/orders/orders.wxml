<!-- è®¢å•ç®¡ç†é¡µé¢ -->
<view class="orders-page">
  <!-- åˆ—è¡¨è§†å›¾ -->
  <view class="list-view" wx:if="{{showListView}}">
    <!-- é¡¶éƒ¨æœç´¢æ  -->
    <view class="search-bar">
      <view class="search-input-wrap">
        <view class="search-icon-text">ğŸ”</view>
        <input 
          class="search-input" 
          placeholder="æœç´¢è®¢å•å·/æ”¶è´§äºº/æ‰‹æœºå·" 
          value="{{searchValue}}"
          confirm-type="search"
          bindconfirm="onSearch"
        />
        <view class="clear-icon" bindtap="clearSearch" wx:if="{{searchValue}}">Ã—</view>
      </view>
      <view class="menu-btn" bindtap="onShowActionSheet">
        <view class="menu-dot"></view>
        <view class="menu-dot"></view>
        <view class="menu-dot"></view>
      </view>
      <view class="export-btn" bindtap="exportOrders">å¯¼å‡º</view>
    </view>
    
    <!-- é¡¶éƒ¨æ ‡ç­¾é¡µ -->
    <view class="tab-bar">
      <view 
        wx:for="{{tabList}}" 
        wx:key="index" 
        class="tab-item {{activeTab === index ? 'active' : ''}}" 
        bindtap="switchTab" 
        data-index="{{index}}">
        {{item}}
      </view>
    </view>
    
    <!-- è®¢å•åˆ—è¡¨ -->
    <view class="order-list">
      <view wx:if="{{loading}}" class="loading-container">
        <view class="loading"></view>
        <text>åŠ è½½ä¸­...</text>
      </view>
      
      <view wx:elif="{{filteredOrders.length === 0}}" class="empty-list">
        <!-- ä½¿ç”¨emojiä»£æ›¿å›¾ç‰‡ -->
        <view class="empty-icon">ğŸ“¦</view>
        <text>æš‚æ— è®¢å•</text>
        <button class="init-demo-btn" bindtap="initTestOrders">åˆå§‹åŒ–æµ‹è¯•è®¢å•</button>
        <button class="init-demo-btn real-order-btn" bindtap="importRealOrders">å¯¼å…¥çœŸå®è®¢å•</button>
      </view>
      
      <block wx:else>
        <!-- æ·»åŠ æ¸…ç©ºè®¢å•æŒ‰é’® -->
        <view class="clean-orders-container">
          <button class="clean-orders-btn" bindtap="clearAllOrders">æ¸…ç©ºæ‰€æœ‰è®¢å•</button>
        </view>
        
        <view 
          wx:for="{{filteredOrders}}" 
          wx:key="_id" 
          wx:for-index="orderIdx"
          class="order-item">
          <view class="order-header">
            <view class="order-top">
              <text class="order-number">è®¢å•å·: {{item.orderNumber || item._id}}</text>
              <view class="order-status-group">
                <view class="order-status {{item.status}}">{{item.statusText}}</view>
                <button 
                  class="action-btn" 
                  catchtap="openActionSheet" 
                  data-id="{{item._id}}">
                  <text class="btn-icon-small">âš™ï¸</text>ä¿®æ”¹
                </button>
              </view>
            </view>
          </view>
          
          <view class="order-content" bindtap="viewOrderDetail" data-id="{{item._id}}">
            <view class="product-list">
              <view 
                wx:for="{{item.products}}" 
                wx:for-item="product" 
                wx:key="id"
                wx:for-index="productIdx"
                class="product-item">
                <image class="product-image" src="{{product.image}}" mode="aspectFill" binderror="handleImageError" data-index="{{productIdx}}" data-order-index="{{orderIdx}}"></image>
                <view class="product-info">
                  <view class="product-name">{{product.name}}</view>
                  <view class="product-spec">{{product.spec}}</view>
                  <view class="product-price-qty">
                    <text class="product-price">Â¥{{product.price}}</text>
                    <text class="product-qty">x{{product.quantity}}</text>
                  </view>
                </view>
              </view>
            </view>
            
            <view class="order-footer">
              <view class="order-time">{{item.createTimeFormat || item.createTime}}</view>
              <view class="order-amount">
                <text>å…±{{item.products.length}}ä»¶å•†å“</text>
                <text>åˆè®¡ï¼š<text class="price">Â¥{{item.totalAmount}}</text></text>
              </view>
            </view>
          </view>
        </view>
        
        <!-- åŠ è½½æ›´å¤š -->
        <view class="loading-more" wx:if="{{loadingMore}}">
          <view class="loading-dot"></view>
          <view class="loading-dot"></view>
          <view class="loading-dot"></view>
        </view>
        
        <!-- æ— æ›´å¤šæ•°æ® -->
        <view class="no-more" wx:if="{{!hasMoreOrders && filteredOrders.length > 0 && !loadingMore}}">
          â€” æ²¡æœ‰æ›´å¤šè®¢å•äº† â€”
        </view>
      </block>
    </view>
  </view>
  
  <!-- è¯¦æƒ…è§†å›¾ -->
  <view class="detail-view" wx:else>
    <!-- æ ‡é¢˜æç¤º -->
    <view class="detail-title-bar">
      <text>è®¢å•è¯¦æƒ…</text>
    </view>
    
    <view class="detail-content">
      <!-- è®¢å•çŠ¶æ€å¡ç‰‡ -->
      <view class="status-card-container">
        <view class="status-card {{currentOrder.status}}">
          <view class="status-icon"></view>
          <text>{{currentOrder.statusText}}</text>
        </view>
        <view class="action-button" bindtap="openActionSheet" data-id="{{currentOrder._id}}">
          <text class="btn-icon-small">âš™ï¸</text> ä¿®æ”¹çŠ¶æ€
        </view>
      </view>

      <!-- è®¢å•ä¿¡æ¯ -->
      <view class="detail-section info-section">
        <view class="section-title">è®¢å•ä¿¡æ¯</view>
        <view class="info-item">
          <text class="info-label">è®¢å•ç¼–å·</text>
          <view class="info-value with-action">
            <text>{{currentOrder.orderNumber || currentOrder._id}}</text>
            <view class="copy-btn" bindtap="copyText" data-text="{{currentOrder.orderNumber || currentOrder._id}}">å¤åˆ¶</view>
          </view>
        </view>
        <view class="info-item">
          <text class="info-label">åˆ›å»ºæ—¶é—´</text>
          <text class="info-value">{{currentOrder.createTimeFormat || currentOrder.createTime}}</text>
        </view>
        <view class="info-item">
          <text class="info-label">æ”¯ä»˜æ–¹å¼</text>
          <text class="info-value">{{currentOrder.paymentMethod || 'å¾®ä¿¡æ”¯ä»˜'}}</text>
        </view>
        <view class="info-item">
          <text class="info-label">æ”¯ä»˜æ—¶é—´</text>
          <text class="info-value">{{currentOrder.paymentTimeFormat || currentOrder.paymentTime || 'æœªçŸ¥'}}</text>
        </view>
      </view>
      
      <!-- é…é€è¿›åº¦ -->
      <view class="detail-section progress-section" wx:if="{{currentOrder.progress}}">
        <view class="section-title">é…é€è¿›åº¦</view>
        <view class="progress-timeline">
          <view 
            wx:for="{{currentOrder.progress}}" 
            wx:key="title"
            class="progress-item {{item.completed ? 'completed' : ''}}">
            <view class="progress-dot"></view>
            <view class="progress-line" wx:if="{{index < currentOrder.progress.length - 1}}"></view>
            <view class="progress-info">
              <view class="progress-title">{{item.title}}</view>
              <view class="progress-desc">{{item.desc}}</view>
              <view class="progress-time" wx:if="{{item.time}}">{{item.time}}</view>
            </view>
          </view>
        </view>
      </view>
      
      <!-- å•†å“ä¿¡æ¯ -->
      <view class="detail-section products-section">
        <view class="section-title">å•†å“ä¿¡æ¯</view>
        <view 
          wx:for="{{currentOrder.products}}" 
          wx:key="id"
          wx:for-index="productIdx"
          class="detail-product-item">
          <image class="detail-product-image" src="{{item.image}}" mode="aspectFill" binderror="handleImageError" data-index="{{productIdx}}"></image>
          <view class="detail-product-info">
            <view class="detail-product-name">{{item.name}}</view>
            <view class="detail-product-spec">è§„æ ¼ï¼š{{item.spec}}</view>
            <view class="detail-product-price-qty">
              <text class="detail-product-price">Â¥{{item.price}}</text>
              <text class="detail-product-qty">x{{item.quantity}}</text>
            </view>
            <view class="detail-product-subtotal">å°è®¡ï¼šÂ¥{{item.price * item.quantity}}</view>
          </view>
        </view>
        
        <view class="order-summary">
          <view class="summary-item">
            <text class="summary-label">å•†å“é‡‘é¢</text>
            <text class="summary-value">Â¥{{calculateSubtotal(currentOrder)}}</text>
          </view>
          <view class="summary-item">
            <text class="summary-label">é…é€è´¹ç”¨</text>
            <text class="summary-value">Â¥{{currentOrder.deliveryFee || '0.00'}}</text>
          </view>
          <view class="summary-item total">
            <text class="summary-label">å®ä»˜é‡‘é¢</text>
            <text class="summary-value price">Â¥{{currentOrder.totalAmount}}</text>
          </view>
        </view>
      </view>
      
      <!-- æ”¶è´§ä¿¡æ¯ -->
      <view class="detail-section address-section">
        <view class="section-title">æ”¶è´§ä¿¡æ¯</view>
        <view class="address-info">
          <view class="user-info">
            <text class="user-name">{{currentOrder.address.name}}</text>
            <text class="user-phone">{{currentOrder.address.phone}}</text>
          </view>
          <view class="address-detail">{{currentOrder.address.detail || currentOrder.address.fullAddress || (currentOrder.address.province + currentOrder.address.city + currentOrder.address.district + currentOrder.address.street)}}</view>
        </view>
      </view>
    </view>
    
    <!-- åº•éƒ¨åˆ†éš”çº¿ -->
    <view class="footer-divider"></view>
    
    <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
    <view class="detail-footer">
      <view class="footer-btn service-btn" bindtap="contactCustomer">
        <text class="btn-icon">ğŸ“</text>
        <text>è”ç³»å®¢æˆ·</text>
      </view>
      <view class="footer-btn back-btn" bindtap="backToList">
        <text class="btn-icon">ğŸ”™</text>
        <text>è¿”å›è®¢å•åˆ—è¡¨</text>
      </view>
    </view>
  </view>
</view>

<!-- åº•éƒ¨Tabbarå ä½ -->
<view class="tabbar-placeholder"></view>

<!-- ä½¿ç”¨ç»Ÿä¸€çš„å¯¼èˆªæ ç»„ä»¶ -->
<admin-tab-bar activeTab="orders"></admin-tab-bar>

<!-- æ“ä½œèœå• -->
<view class="action-sheet {{showActionSheet ? 'show' : ''}}" catchtouchmove="preventTouchMove">
  <view class="action-sheet-mask" bindtap="closeActionSheet"></view>
  <view class="action-sheet-container">
    <view class="action-sheet-header">
      <text>è®¢å•æ“ä½œ</text>
      <view class="close-icon" bindtap="closeActionSheet">Ã—</view>
    </view>
    <view class="action-sheet-content">
      <view 
        wx:for="{{actions}}" 
        wx:key="value" 
        class="action-item"
        data-value="{{item.value}}"
        bindtap="handleAction">
        {{item.name}}
      </view>
    </view>
    <view class="action-sheet-footer">
      <view class="cancel-btn" bindtap="closeActionSheet">å–æ¶ˆ</view>
    </view>
  </view>
</view>

<!-- æ¨¡æ‹Ÿæ•°æ® -->
<wxs module="mockData">
  module.exports = {
    mockProducts: [
      { 
        id: 1, 
        image: '/assets/images/products/product-croissant.jpg',
        name: 'æ³•å¼ç‰›è§’é¢åŒ…',
        spec: 'åŸå‘³Â·è½»çƒ˜ç„™Â·æ˜“åŒ…è£…',
        price: 24.00,
        count: 2
      },
      { 
        id: 2, 
        image: '/assets/images/products/product-brownie.jpg',
        name: 'æŠ¹èŒ¶çº¢è±†è›‹ç³•',
        spec: 'æ ‡å‡†ç”œåº¦Â·å°ä»¶è£…',
        price: 28.00,
        count: 1
      },
      { 
        id: 3, 
        image: '/assets/images/products/product-tiramisu.jpg',
        name: 'ç»å…¸ææ‹‰ç±³è‹',
        spec: 'æ ‡å‡†ç”œåº¦Â·å°ä»¶è£…',
        price: 38.00,
        count: 1
      }
    ]
  }
</wxs> 